{% extends "base.html" %}

{% block content %}
<div class="page-container">

    <!-- Login / Logout Links -->
    <div class="auth-links">
        {% if 'user_id' in session %}
            Logged in
            <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
    </div>

    <!-- Calendar -->
    <div class="calendar-container">
        <div class="calendar-header">
            <button class="left-calendar" onclick="goToMonth({{ month-1 if month>1 else 12 }}, {{ year if month>1 else year-1 }})">&lt;</button>
            <h1>{{ month }}/{{ year }}</h1>
            <button class="right-calendar" onclick="goToMonth({{ month+1 if month<12 else 1 }}, {{ year if month<12 else year+1 }})">&gt;</button>
        </div>

        <div class="calendar-grid">
            {% for weekday in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
                <div class="weekday">{{ weekday }}</div>
            {% endfor %}
            {% for week in month_days %}
                {% for day in week %}
                <div class="day {% if day == today %}today{% elif day.month != month %}other-month{% endif %}">
                    <a href="{{ url_for('show_calendar', year=year, month=month, date=day) }}"
                       class="{% if selected_date and day == selected_date %}selected{% endif %}">
                        {{ day.day }}
                    </a>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
    <hr>
    <!-- Events -->
    <div class="events-container">
        {% set day_to_show = selected_date if selected_date else today %}
        <h3 class="events-title">Events for {{ day_to_show }}</h3>

        {% if 'user_id' in session %}
            <button class="add-event" onclick="openAddEvent('{{ day_to_show }}')">+ Add Event</button>
        {% endif %}
        
        <div class="notifications">
        {% if events %}
            {% for event in events %}
                <p>
                    {{event[1]}}, 
                    {% if event[2] and event[3] %}
                        ({{ event[2] }} - {{ event[3] }}),
                    {% endif %}
                    {{event[4]}},
                    Location: {{ event[5] }}
                </p>
                {% if 'user_id' in session and (event[6]==session['user_id'] or session['is_admin']) %}
                    <form method="POST" action="{{ url_for('delete_event', id=event[0]) }}" class="inline-form">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                    <a href="{{ url_for('edit_event', event_id=event[0]) }}">
                        <button type="button" class="edit-btn">Edit</button>
                    </a>
                {% endif %}
            {% endfor %}
        {% endif %}
        </div>
        

        <!-- Add Event Modal -->
        {% if 'user_id' in session %}
        <div class="modalHolder">
            <div id="addEventModal" class="modal">
                <form id="addEventForm" method="POST" class="modal-form">
                    <h2>Add an Event</h2>
                    <label>Title: <input type="text" name="title" required></label>
                    <div class="time-select-container">
                        <label>Start:</label>
                        <select name="start_hour">{% for h in range(0,24) %}<option value="{{'%02d' % h}}">{{'%02d' % h}}</option>{% endfor %}</select>
                        :
                        <select name="start_minute">{% for m in range(0,60,5) %}<option value="{{'%02d' % m}}">{{'%02d' % m}}</option>{% endfor %}</select>
                    </div>

                    <div class="time-select-container">
                        <label>Final:</label>
                        <select name="end_hour">{% for h in range(0,24) %}<option value="{{'%02d' % h}}">{{'%02d' % h}}</option>{% endfor %}</select>
                        :
                        <select name="end_minute">{% for m in range(0,60,5) %}<option value="{{'%02d' % m}}">{{'%02d' % m}}</option>{% endfor %}</select>
                    </div>

                    <label>Specs: <input name="details"></label>
                    <label>Venue: <input type="text" name="location"></label>
                    <label>Make event public<input type="checkbox" name="is_public" value="true"></label>
                    
                    <div class="buttons-holder-holder">
                        <div class="modal-buttons">
                            <button id="cancel" type="button" onclick="closeAddEvent()">Cancel</button>
                            <button type="submit">Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

</div>

<script>
function goToMonth(month, year) {
    window.location.href = `/show_calendar/${year}/${month}/`;
}
function openAddEvent(date) {
    const form = document.getElementById('addEventForm');
    form.action = '/addevent/' + date + '/';
    document.getElementById('addEventModal').style.display = 'block';
}
function closeAddEvent() {
    document.getElementById('addEventModal').style.display = 'none';
}
</script>
{% endblock %}
