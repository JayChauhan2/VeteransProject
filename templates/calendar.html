{% extends "base.html" %}

{% block content %}
<div class="page-container">

    <!-- Login / Logout Links -->
    <div class="auth-links">
        {% if 'user_id' in session %}
            Logged in
            <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
    </div>

    <!-- Calendar -->
    <div class="calendar-container">
        <div class="calendar-header">
            <button onclick="goToMonth({{ month-1 if month>1 else 12 }}, {{ year if month>1 else year-1 }})">&lt;</button>
            <h2>{{ month }}/{{ year }}</h2>
            <button onclick="goToMonth({{ month+1 if month<12 else 1 }}, {{ year if month<12 else year+1 }})">&gt;</button>
        </div>

        <div class="calendar-grid">
            {% for weekday in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
                <div class="weekday">{{ weekday }}</div>
            {% endfor %}
            {% for week in month_days %}
                {% for day in week %}
                <div class="day {% if day == today %}today{% elif day.month != month %}other-month{% endif %}">
                    <a href="{{ url_for('show_calendar', year=year, month=month, date=day) }}"
                       class="{% if selected_date and day == selected_date %}selected{% endif %}">
                        {{ day.day }}
                    </a>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- Events -->
    <div class="events-container">
        {% set day_to_show = selected_date if selected_date else today %}
        <h2>Events for {{ day_to_show }}</h2>

        {% if 'user_id' in session %}
            <button onclick="openAddEvent('{{ day_to_show }}')">+ Add Event</button>
        {% endif %}

        <ul class="event-list">
            {% if events %}
                {% for event in events %}
                    <li>
                        <strong>{{ event[1] }}</strong>
                        {% if event[2] and event[3] %}
                            ({{ event[2] }} - {{ event[3] }})
                        {% endif %}
                        <br>{{ event[4] }}
                        <br>Location: {{ event[5] }}
                        <br>
                        {% if 'user_id' in session and (event[6]==session['user_id'] or session['is_admin']) %}
                            <form method="POST" action="{{ url_for('delete_event', id=event[0]) }}" class="inline-form">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                            <a href="{{ url_for('edit_event', event_id=event[0]) }}">
                                <button type="button">Edit</button>
                            </a>
                        {% endif %}
                    </li>
                {% endfor %}
            {% else %}
                <li>No events for this day.</li>
            {% endif %}
        </ul>

        <!-- Add Event Modal -->
        {% if 'user_id' in session %}
        <div id="addEventModal" class="modal">
            <form id="addEventForm" method="POST" class="modal-form">
                <label>Title: <input type="text" name="title" required></label>
                
                <div class="time-select-container">
                    <label>Start Time:</label>
                    <select name="start_hour">{% for h in range(0,24) %}<option value="{{'%02d' % h}}">{{'%02d' % h}}</option>{% endfor %}</select>
                    :
                    <select name="start_minute">{% for m in range(0,60,5) %}<option value="{{'%02d' % m}}">{{'%02d' % m}}</option>{% endfor %}</select>
                </div>

                <div class="time-select-container">
                    <label>End Time:</label>
                    <select name="end_hour">{% for h in range(0,24) %}<option value="{{'%02d' % h}}">{{'%02d' % h}}</option>{% endfor %}</select>
                    :
                    <select name="end_minute">{% for m in range(0,60,5) %}<option value="{{'%02d' % m}}">{{'%02d' % m}}</option>{% endfor %}</select>
                </div>

                <label>Details: <textarea name="details"></textarea></label>
                <label>Location: <input type="text" name="location"></label>
                <label><input type="checkbox" name="is_public" value="true"> Make event public</label>

                <div class="modal-buttons">
                    <button type="submit">Save</button>
                    <button type="button" onclick="closeAddEvent()">Cancel</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>

</div>

<style>
.page-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}
.auth-links {
    text-align: right;
    margin: 5px 10px;
}
.calendar-container { flex: 0 0 45%; overflow-y: auto; padding: 5px; }
.events-container { flex: 0 0 55%; overflow-y: auto; padding: 10px; background: #f9f9f9; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
.weekday { text-align: center; font-weight: 600; }
.day a { display: flex; justify-content: center; align-items: center; aspect-ratio:1; border-radius:50%; text-decoration:none; color:#000; font-weight:500; }
.day.today a { background:#007aff; color:#fff; }
.day.other-month a { color:#ccc; }
.day a.selected { border:2px solid #007aff; }
.event-list { list-style:none; padding:0; margin:0; }
.inline-form { display:inline; margin-right:5px; }
button { padding:5px 10px; margin:3px; border:none; border-radius:8px; background:#007aff; color:#fff; cursor:pointer; }
button:hover { background:#005bb5; }
.delete-btn { background:none; border:none; color:red; cursor:pointer; }
.modal { display:none; position:fixed; top:20%; left:10%; width:80%; max-width:400px; background:#fff; border:1px solid #ccc; padding:20px; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.2); border-radius:12px; }
.modal-form label { display:block; margin:8px 0; }
.time-select-container { display:flex; align-items:center; gap:5px; margin:5px 0; }
.modal-buttons { display:flex; justify-content:flex-end; gap:10px; margin-top:10px; }
</style>

<script>
function goToMonth(month, year) {
    window.location.href = `/show_calendar/${year}/${month}/`;
}
function openAddEvent(date) {
    const form = document.getElementById('addEventForm');
    form.action = '/addevent/' + date + '/';
    document.getElementById('addEventModal').style.display = 'block';
}
function closeAddEvent() {
    document.getElementById('addEventModal').style.display = 'none';
}
</script>
{% endblock %}
